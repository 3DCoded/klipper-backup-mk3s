# 3MS Tip Forming Configuration
# by Christopher Mattar (3DCoded)

## ----- DO NOT EDIT ---- ##

# FORM_TIP macro based on this method:
# https://www.3dchameleon.com/forum/your-3d-chameleon-creations/20-second-color-changes-on-k1-max
# This macro is designed to be universal, reliable, and fast.

## Parameters you will likely change:
# COOLING_TUBE_POS
#   This is the distance between the bottom of the heatsink to the tip of your nozzle
# COOLING_TUBE_LENGTH
#   This is the length of the heatsink
# COOLING_SPEED
#   Increase this as far as you can until the filament tips come out warm and pliable
# FINAL_RETRACT
#   This is the distance from the top of the heatsink to the top of your extruder (right above the extruder gears)
[gcode_macro FORM_TIP]
gcode:
  {% set push_distance = params.PUSH_DISTANCE|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_push_distance)|int %}
    {% set push_speed = params.PUSH_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_push_speed)|int %}
    {% set cooling_tube_pos = params.COOLING_TUBE_POS|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_cooling_tube_pos)|int %}
    {% set initial_retract_speed = params.INITIAL_RETRACT_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_initial_retract_speed)|int %}
    {% set cooling_tube_length = params.COOLING_TUBE_LENGTH|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_cooling_tube_length)|int %}
    {% set cooling_speed = params.COOLING_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_cooling_speed)|int %}
    {% set final_retract = params.FINAL_RETRACT|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_final_retract)|int %}
    {% set final_speed = params.FINAL_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].variable_final_speed)|int %}

  # Setup extruder
  M83
  G92 E0

  # Push out molten filament
  G0 E{push_distance} F{push_speed}

  # Rapid retract to cooling tube
  G0 E-{cooling_tube_pos} F{initial_retract_speed}

  # Slow single cooling move
  G0 E-{cooling_tube_length} F{cooling_speed}

  # Final retraction out of extruder
  G0 E-{final_retract} F{final_speed}





## Form Tip Settings
[gcode_macro FORM_TIP_SETTINGS]
variable_push_distance: 10
variable_push_speed: 500
variable_cooling_tube_pos: 15
variable_initial_retract_speed: 4000
variable_cooling_tube_length: 11
variable_cooling_speed: 150
variable_final_retract: 49
variable_final_speed: 4000
gcode:
    RESPOND MSG="This macro is not meant to be run."

[gcode_macro GET_TIP_SETTINGS]
gcode:
    {% set push_distance = printer["gcode_macro FORM_TIP_SETTINGS"].variable_push_distance %}
    {% set push_speed = printer["gcode_macro FORM_TIP_SETTINGS"].variable_push_speed %}
    {% set cooling_tube_pos = printer["gcode_macro FORM_TIP_SETTINGS"].variable_cooling_tube_pos %}
    {% set initial_retract_speed = printer["gcode_macro FORM_TIP_SETTINGS"].variable_initial_retract_speed %}
    {% set cooling_tube_length = printer["gcode_macro FORM_TIP_SETTINGS"].variable_cooling_tube_length %}
    {% set cooling_speed = printer["gcode_macro FORM_TIP_SETTINGS"].variable_cooling_speed %}
    {% set final_retract = printer["gcode_macro FORM_TIP_SETTINGS"].variable_final_retract %}
    {% set final_speed = printer["gcode_macro FORM_TIP_SETTINGS"].variable_final_speed %}

    M117 PUSH_DISTANCE = {push_distance}
    M117 PUSH_SPEED = {push_speed}
    M117 COOLING_TUBE_POS = {cooling_tube_pos}
    M117 INITIAL_RETRACT_SPEED = {initial_retract_speed}
    M117 COOLING_TUBE_LENGTH = {cooling_tube_length}
    M117 COOLING_SPEED = {cooling_speed}
    M117 FINAL_RETRACT = {final_retract}
    M117 FINAL_SPEED = {final_speed}

[gcode_macro SET_TIP_SETTINGS]
gcode:
    {% if params.PUSH_DISTANCE is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=push_distance VALUE={params.PUSH_DISTANCE}
    {% endif %}
    {% if params.PUSH_SPEED is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=push_speed VALUE={params.PUSH_SPEED}
    {% endif %}
    {% if params.COOLING_TUBE_POS is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=cooling_tube_pos VALUE={params.COOLING_TUBE_POS}
    {% endif %}
    {% if params.INITIAL_RETRACT_SPEED is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=initial_retract_speed VALUE={params.INITIAL_RETRACT_SPEED}
    {% endif %}
    {% if params.COOLING_TUBE_LENGTH is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=cooling_tube_length VALUE={params.COOLING_TUBE_LENGTH}
    {% endif %}
    {% if params.COOLING_SPEED is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=cooling_speed VALUE={params.COOLING_SPEED}
    {% endif %}
    {% if params.FINAL_RETRACT is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=final_retract VALUE={params.FINAL_RETRACT}
    {% endif %}
    {% if params.FINAL_SPEED is defined %}
        SET_GCODE_VARIABLE MACRO=FORM_TIP_SETTINGS VARIABLE=final_speed VALUE={params.FINAL_SPEED}
    {% endif %}
  