[gcode_macro G101]
gcode:
  {% set T = params.T|int %}
  {% set E = params.E|default(0)|float %}
  {% set F = params.F|default(3000)|float %}
  {% set N = params.N|default(1)|int %}

  MMMS_TMCHoming
  G4 P500
  {% if N == 0 and E == 0 %}
  MANUAL_STEPPER STEPPER=3ms{T} ENABLE=0
  {% else %}
  MANUAL_STEPPER STEPPER=3ms{T} ENABLE=1
  MANUAL_STEPPER STEPPER=3ms{T} ENABLE=1 SET_POSITION=0
  MANUAL_STEPPER STEPPER=3ms{T} ENABLE=1 MOVE={E} SPEED={F/60} ACCEL=1000 STOP_ON_ENDSTOP=1
  MANUAL_STEPPER STEPPER=3ms{T} ENABLE={N}
  {% endif %}
  MMMS_TMCSilent