# 3MS Tip Forming Settings
# by Christopher Mattar (3DCoded)

## ----- DO NOT EDIT ---- ##

# FORM_TIP macro based on this method:
# https://www.3dchameleon.com/forum/your-3d-chameleon-creations/20-second-color-changes-on-k1-max
# This macro is designed to be universal, reliable, and fast.

# ████████╗██╗██████╗     ███████╗ ██████╗ ██████╗ ███╗   ███╗██╗███╗   ██╗ ██████╗ 
# ╚══██╔══╝██║██╔══██╗    ██╔════╝██╔═══██╗██╔══██╗████╗ ████║██║████╗  ██║██╔════╝ 
#    ██║   ██║██████╔╝    █████╗  ██║   ██║██████╔╝██╔████╔██║██║██╔██╗ ██║██║  ███╗
#    ██║   ██║██╔═══╝     ██╔══╝  ██║   ██║██╔══██╗██║╚██╔╝██║██║██║╚██╗██║██║   ██║
#    ██║   ██║██║         ██║     ╚██████╔╝██║  ██║██║ ╚═╝ ██║██║██║ ╚████║╚██████╔╝
#    ╚═╝   ╚═╝╚═╝         ╚═╝      ╚═════╝ ╚═╝  ╚═╝╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝ ╚═════╝ 

# Tip Forming
# FORM_TIP macro
# Forms the filament tip before unloading
[gcode_macro FORM_TIP]
gcode:
  {% set push_distance = params.PUSH_DISTANCE|default(printer["gcode_macro FORM_TIP_SETTINGS"].push_distance)|int %}
  {% set push_speed = params.PUSH_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].push_speed)|int %}
  {% set cooling_tube_pos = params.COOLING_TUBE_POS|default(printer["gcode_macro FORM_TIP_SETTINGS"].cooling_tube_pos)|int %}
  {% set initial_retract_speed = params.INITIAL_RETRACT_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].initial_retract_speed)|int %}
  {% set cooling_tube_length = params.COOLING_TUBE_LENGTH|default(printer["gcode_macro FORM_TIP_SETTINGS"].cooling_tube_length)|int %}
  {% set cooling_speed = params.COOLING_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].cooling_speed)|int %}
  {% set final_retract = params.FINAL_RETRACT|default(printer["gcode_macro FORM_TIP_SETTINGS"].final_retract)|int %}
  {% set final_speed = params.FINAL_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].final_speed)|int %}

  {% if push_distance > -1 %}
    # Setup extruder
    M83
    G92 E0
    # Push out molten filament
    G0 E{push_distance} F{push_speed*60}
    # Rapid retract to cooling tube
    G0 E-{cooling_tube_pos} F{initial_retract_speed*60}
    # Slow single cooling move
    G0 E-{cooling_tube_length} F{cooling_speed*60}
    # Final retraction out of extruder
    G0 E-{final_retract} F{final_speed*60}
  {% endif %}

# Tip Loading
# LOAD_TIP macro
# Loads the filament tip after a toolchange is complete
[gcode_macro LOAD_TIP]
gcode:
  {% set cooling_tube_pos = printer["gcode_macro FORM_TIP_SETTINGS"].cooling_tube_pos|int %}
  {% set cooling_tube_length = printer["gcode_macro FORM_TIP_SETTINGS"].cooling_tube_length|int %}
  {% set final_retract = printer["gcode_macro FORM_TIP_SETTINGS"].final_retract|int %}
  {% set extra_loading_distance = printer["gcode_macro FORM_TIP_SETTINGS"].extra_loading_distance|int %}
  {% set loading_speed = printer["gcode_macro FORM_TIP_SETTINGS"].final_speed|int %}

  M83
  G92 E0
  G1 E{cooling_tube_pos + cooling_tube_length + final_retract + extra_loading_distance} F{loading_speed*60}