# 3MS Tip Forming Settings
# by Christopher Mattar (3DCoded)

## ----- DO NOT EDIT ---- ##

# FORM_TIP macro based on this method:
# https://www.3dchameleon.com/forum/your-3d-chameleon-creations/20-second-color-changes-on-k1-max
# This macro is designed to be universal, reliable, and fast.

# ████████╗██╗██████╗     ███████╗ ██████╗ ██████╗ ███╗   ███╗██╗███╗   ██╗ ██████╗ 
# ╚══██╔══╝██║██╔══██╗    ██╔════╝██╔═══██╗██╔══██╗████╗ ████║██║████╗  ██║██╔════╝ 
#    ██║   ██║██████╔╝    █████╗  ██║   ██║██████╔╝██╔████╔██║██║██╔██╗ ██║██║  ███╗
#    ██║   ██║██╔═══╝     ██╔══╝  ██║   ██║██╔══██╗██║╚██╔╝██║██║██║╚██╗██║██║   ██║
#    ██║   ██║██║         ██║     ╚██████╔╝██║  ██║██║ ╚═╝ ██║██║██║ ╚████║╚██████╔╝
#    ╚═╝   ╚═╝╚═╝         ╚═╝      ╚═════╝ ╚═╝  ╚═╝╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝ ╚═════╝ 

# Tip Forming
# FORM_TIP macro
## Parameters you will likely change:
# COOLING_TUBE_POS
#   This is the distance between the bottom of the heatsink to the tip of your nozzle
# COOLING_TUBE_LENGTH
#   This is the length of the heatsink
# COOLING_SPEED
#   Increase this as far as you can until the filament tips come out warm and pliable
# FINAL_RETRACT
#   This is the distance from the top of the heatsink to the top of your extruder (right above the extruder gears)
[gcode_macro FORM_TIP]
gcode:
  {% set push_distance = params.PUSH_DISTANCE|default(printer["gcode_macro FORM_TIP_SETTINGS"].push_distance)|int %}
  {% set push_speed = params.PUSH_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].push_speed)|int %}
  {% set cooling_tube_pos = params.COOLING_TUBE_POS|default(printer["gcode_macro FORM_TIP_SETTINGS"].cooling_tube_pos)|int %}
  {% set initial_retract_speed = params.INITIAL_RETRACT_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].initial_retract_speed)|int %}
  {% set cooling_tube_length = params.COOLING_TUBE_LENGTH|default(printer["gcode_macro FORM_TIP_SETTINGS"].cooling_tube_length)|int %}
  {% set cooling_speed = params.COOLING_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].cooling_speed)|int %}
  {% set final_retract = params.FINAL_RETRACT|default(printer["gcode_macro FORM_TIP_SETTINGS"].final_retract)|int %}
  {% set final_speed = params.FINAL_SPEED|default(printer["gcode_macro FORM_TIP_SETTINGS"].final_speed)|int %}

  {% if push_distance > -1 %}
    # Setup extruder
    M83
    G92 E0
    # Push out molten filament
    G0 E{push_distance} F{push_speed*60}
    # Rapid retract to cooling tube
    G0 E-{cooling_tube_pos} F{initial_retract_speed*60}
    # Slow single cooling move
    G0 E-{cooling_tube_length} F{cooling_speed*60}
    # Final retraction out of extruder
    G0 E-{final_retract} F{final_speed*60}
  {% endif %}