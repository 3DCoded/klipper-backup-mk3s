[save_variables]
filename: ~/printer_data/config/3ms/variables.cfg

[gcode_macro Toolchange]
gcode:
  {% set p = printer.save_variables.variables.p|int %}
  {% set t = params.T|int %}
  {% if p != t %} ; only toolchange if different tool
    {% if p > -1 %}
      M83
      G92 E0
      G1 E-45 F1500
      G100 T{p} E-175 F4500 N0
      G4 P500
      QUERY_FILAMENT_SENSOR SENSOR=fsensor
      CHECK_FSENSOR V=0
    {% endif %}
      G100 T{t} E200 F4500 N0
      G4 P500
      QUERY_FILAMENT_SENSOR SENSOR=fsensor
      CHECK_FSENSOR V=1
    {% if p == -1 %}
      G1 E65 F900
    {% endif %}
  {% endif %}
  SAVE_VARIABLE VARIABLE=p VALUE={t}

[gcode_macro CHECK_FSENSOR]
gcode:
  {% set v = params.V|int %}
  {% if (printer["filament_switch_sensor fsensor"].filament_detected)|int != v %}
    M117 Sensor Check Fail
    PAUSE
  {% endif %}

[gcode_macro CLEAR_TOOL]
gcode:
  SAVE_VARIABLE VARIABLE=p VALUE=-1

[gcode_macro T0]
gcode:
  Toolchange T=0

[gcode_macro T1]
gcode:
  Toolchange T=1

[include ./steppers.cfg]
[include ./g100.cfg]
[include ./g101.cfg]
[include ./ks.cfg]
[include ./tmc.cfg]