[gcode_macro Toolchange]
gcode:
  {% set p = printer.save_variables.variables.p|int %}
  {% set t = params.T|int %}
  M118 T{p} -> T{t}
  {% if p != t %} ; Only toolchange if different tool
    {% if p > -1 %}
      MMMS_UNLOAD DISTANCE=200 ; Unload filament
      DESYNC_TOOL TOOL={p} ; Desync stepper from extruder
      CHECK_FSENSOR V=0 ; Check filament sensor
    {% endif %}
    
    SYNC_TOOL TOOL={t}
    MMMS_LOAD DISTANCE=210
    CHECK_FSENSOR V=1
  {% endif %}
  SAVE_VARIABLE VARIABLE=p VALUE={t}

[gcode_macro MMMS_UNLOAD]
gcode:
  {% set distance = params.DISTANCE|int %}
  {% set times = (distance / 50)|int %}
  M83
  {% for _ in range(times) %}
    G1 E-50 F4500
  {% endfor %}
  G1 E-{distance-(times*50)} F4500

[gcode_macro MMMS_LOAD]
gcode:
  {% set distance = params.DISTANCE|int %}
  {% set times = (distance / 50)|int %}
  M83
  {% for _ in range(times) %}
    G1 E50 F4500
  {% endfor %}
  G1 E{distance-(times*50)} F4500

[gcode_macro CHECK_FSENSOR]
gcode:
  {% set v = params.V|int %}
  {% if (printer["filament_switch_sensor fsensor"].filament_detected)|int != v %}
    M117 Sensor Check Fail {params.M}
    PAUSE
  {% endif %}

[gcode_macro SET_TOOL_SYNC]
gcode:
  {% set tool = params.TOOL|int %}
  {% set sync = params.SYNC|int %}
  {% if sync == 1 %}
    {% set motion_queue = "extruder" %}
  {% else %}
    {% set motion_queue = "" %}
  {% endif %}
  SYNC_EXTRUDER_MOTION EXTRUDER=3ms{tool} MOTION_QUEUE={motion_queue}

[gcode_macro SYNC_TOOL]
gcode:
  {% set tool = params.TOOL|int %}
  SET_TOOL_SYNC TOOL={tool} SYNC=1

[gcode_macro DESYNC_TOOL]
gcode:
  {% set tool = params.TOOL|int %}
  SET_TOOL_SYNC TOOL={tool} SYNC=0

[gcode_macro CLEAR_TOOL]
gcode:
  SAVE_VARIABLE VARIABLE=p VALUE=-1

[gcode_macro DESYNC_ALL_TOOLS]
gcode:
  {% for tool in range(2) %}
    DESYNC_TOOL TOOL={tool}
  {% endfor %}

[gcode_macro T0]
gcode:
  Toolchange T=0

[gcode_macro T1]
gcode:
  Toolchange T=1